<html>
  <head>

    <title>SegmentAnything Bookmarklet for Cornerstone</title>

  </head>

  <body>

    <strong>Run <a href="https://segment-anything.com/" target=_blank>Meta's Segment Anything</a> model for <a href="https://www.cornerstonejs.org/" target=_blank>cornerstone.js</a> via JavaScript injection.</strong><br><br>

    <img src='bookmarklet.gif' width=500><br><br>

    <span style='font-size:24px'>Drag this: <a id="bookmarklet-a" class="bookmarklet" href="javascript:(function()%7B%2F%2F%20GET%20EMBEDDING%20FOR%20CANVAS%0Aelement%20%3D%20cornerstone.getEnabledElements()%5B0%5D%3B%0Acanvas%20%3D%20element.canvas%3B%0Aheight%20%3D%20canvas.height%3B%0Awidth%20%3D%20canvas.width%3B%0A%0Abase64%20%3D%20canvas.toDataURL('image%2Fpng')%0Abase64%20%3D%20base64.replace(%22data%3Aimage%2Fpng%3Bbase64%2C%22%2C%22%22)%0Auint8arr%20%3D%20Uint8Array.from(atob(base64)%2C%20(c)%20%3D%3E%20c.charCodeAt(0))%3B%0A%0Aendpoint%20%3D%20'https%3A%2F%2Fmodel-zoo.metademolab.com%2Fpredictions%2Fsegment_everything_box_model'%3B%20%20%20%20%20%20%20%20%0A%0Axhr%20%3D%20new%20XMLHttpRequest()%3B%0Axhr.open(%22POST%22%2C%20endpoint)%3B%0Axhr.onreadystatechange%20%3D%20function%20()%20%7B%0A%20%20if%20(xhr.readyState%20%3D%3D%3D%204)%20%7B%0A%0A%20%20%20%20embedding%20%3D%20JSON.parse(xhr.response)%3B%0A%0A%20%20%20%20%2F%2F%20LOAD%20ONNX%20RUNTIME%0A%20%20%20%20const%20script%20%3D%20document.createElement(%22script%22)%0A%20%20%20%20script.type%20%3D%20%22text%2Fjavascript%22%0A%20%20%20%20script.src%20%3D%20%22https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2Fonnxruntime-web%2Fdist%2Fort.min.js%22%0A%20%20%20%20document.head.appendChild(script)%0A%20%20%20%20eval(script)%0A%0A%0A%20%20%2F%2F%20ENABLE%20ROI%20INTERACTION%0A%20%20cornerstoneTools.setToolActive('RectangleRoi'%2C%20%7B%20mouseButtonMask%3A%201%20%7D)%0A%0A%0A%20%20%7D%0A%7D%0Axhr.send(uint8arr)%3B%0A%0A%2F%2F%20SEGMENT%0Aasync%20function%20segment(embedding%2C%20height%2C%20width%2C%20x1%2C%20y1%2C%20x2%2C%20y2)%20%7B%0A%0A%20%20session%20%3D%20await%20ort.InferenceSession.create('https%3A%2F%2Fcs666.org%2Fonnx%2Fsam.onnx')%3B%0A%0A%20%20input%20%3D%20%7B%7D%3B%0A%0A%20%20uint8arr%20%3D%20Uint8Array.from(atob(embedding%5B0%5D)%2C%20(c)%20%3D%3E%20c.charCodeAt(0))%3B%0A%20%20embedding%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(uint8arr.buffer)%2C%20%5B1%2C%20256%2C%2064%2C%2064%5D)%3B%0A%20%20input%5B'low_res_embedding'%5D%20%3D%20embedding%3B%0A%0A%20%20console.log(embedding)%0A%0A%20%20input%5B'point_coords'%5D%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(%5Bx1%2Cy1%2Cx2%2Cy2%5D)%2C%20%5B1%2C%202%2C%202%5D)%3B%0A%0A%0A%20%20%2F%2F%202%20and%203%20mean%20top-left-bottom-right%20box%0A%20%20input%5B'point_labels'%5D%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(%5B2%2C3%5D)%2C%20%5B1%2C%202%5D)%3B%0A%0A%20%20%2F%2F%20original%20image%20size%0A%20%20input%5B'image_size'%5D%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(%5Bheight%2C%20width%5D))%3B%0A%0A%20%20%2F%2F%20empty%20mask%0A%20%20input%5B'last_pred_mask'%5D%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(256%20*%20256)%2C%20%5B1%2C%201%2C%20256%2C%20256%5D)%3B%0A%20%20input%5B'has_last_pred'%5D%20%3D%20new%20ort.Tensor(%22float32%22%2C%20new%20Float32Array(%5B0%5D))%3B%0A%0A%20%20return%20session.run(%20input%20).then(%20output%20%3D%3E%20%7B%0A%0A%20%20%20%20ctx%20%3D%20canvas.getContext('2d')%3B%0A%0A%20%20%20%20image%20%3D%20ctx.getImageData(0%2C0%2Cwidth%2Cheight)%0A%0A%20%20%20%20mask%20%3D%20arrayToImageData(output.output.data%2C%20image%2C%20width%2C%20height)%3B%0A%20%20%20%20%0A%20%20%20%20ctx.putImageData(mask%2C%200%2C%200)%3B%0A%0A%20%20%20%20return%20output.output.data%3B%0A%0A%20%20%7D).catch(err%20%3D%3E%20%7B%0A%0A%20%20%20%20console.error(err)%3B%0A%0A%20%20%7D)%3B%0A%0A%7D%3B%0A%0A%2F%2F%20CONVERT%20ARRAY%20TO%20IMAGEDATA%0Afunction%20arrayToImageData(mask%2C%20image%2C%20width%2C%20height)%20%7B%0A%20%20%2F%2F%20From%3A%20https%3A%2F%2Fgithub.com%2Ffacebookresearch%2Fsegment-anything%2Fblob%2F40df6e4046d8b07ab8c4519e083408289eb43032%2Fdemo%2Fsrc%2Fcomponents%2Fhelpers%2FmaskUtils.tsx%0A%20%20%2F%2F%20Copyright%20(c)%20Meta%20Platforms%2C%20Inc.%20and%20affiliates.%0A%20%20%2F%2F%20All%20rights%20reserved.%0A%0A%20%20%2F%2F%20This%20source%20code%20is%20licensed%20under%20the%20license%20found%20in%20the%0A%20%20%2F%2F%20LICENSE%20file%20in%20the%20root%20directory%20of%20this%20source%20tree.%0A%20%20%5Br%2C%20g%2C%20b%2C%20a%5D%20%3D%20%5B0%2C%20114%2C%20189%2C%20255%5D%3B%20%2F%2F%20the%20masks's%20blue%20color%0A%0A%20%20arr%20%3D%20image.data%3B%2F%2Fnew%20Uint8ClampedArray(4%20*%20width%20*%20height)%3B%0A%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20mask.length%3B%20i%2B%2B)%20%7B%0A%0A%20%20%20%20%2F%2F%20Threshold%20the%20onnx%20model%20mask%20prediction%20at%200.0%0A%20%20%20%20%2F%2F%20This%20is%20equivalent%20to%20thresholding%20the%20mask%20using%20predictor.model.mask_threshold%0A%20%20%20%20%2F%2F%20in%20python%0A%20%20%20%20if%20(mask%5Bi%5D%20%3E%200.0)%20%7B%0A%20%20%20%20%20%20arr%5B4%20*%20i%20%2B%200%5D%20%3D%20r%3B%0A%20%20%20%20%20%20arr%5B4%20*%20i%20%2B%201%5D%20%3D%20g%3B%0A%20%20%20%20%20%20arr%5B4%20*%20i%20%2B%202%5D%20%3D%20b%3B%0A%20%20%20%20%20%20arr%5B4%20*%20i%20%2B%203%5D%20%3D%20a%3B%0A%20%20%20%20%7D%0A%0A%20%20%7D%0A%20%20%0A%20%20return%20new%20ImageData(arr%2C%20width%2C%20height)%3B%0A%0A%7D%3B%0A%0A%2F%2F%20REGISTER%20CALLBACK%20THAT%20TRIGGERS%20SAM%0Acanvas.onmouseup%20%3D%20function(e)%20%7B%0A%20%20%0A%20%20state%20%3D%20cornerstoneTools.globalImageIdSpecificToolStateManager.saveToolState()%3B%0A%0A%20%20topleft%20%3D%20state%5BObject.keys(state).pop()%5D.RectangleRoi.data%5B0%5D.handles.start%3B%0A%20%20bottomright%20%3D%20state%5BObject.keys(state).pop()%5D.RectangleRoi.data%5B0%5D.handles.end%3B%0A%0A%20%20topleft_c%20%3D%20cornerstone.pixelToCanvas(element.element%2C%20topleft)%3B%0A%20%20bottomright_c%20%3D%20cornerstone.pixelToCanvas(element.element%2C%20bottomright)%3B%0A%0A%20%20cornerstoneTools.clearToolState(element.element%2C%20'RectangleRoi')%0A%20%20cornerstone.renderGrayscaleImage(element%2C%20true)%0A%20%20%0A%20%20mask%20%3D%20segment(embedding%2C%20height%2C%20width%2C%20topleft_c.x%2C%20topleft_c.y%2C%20bottomright_c.x%2C%20bottomright_c.y)%3B%0A%0A%7D%7D)()%3B">SAM</a> into your bookmarks toolbar and visit <a href="https://viewer.imaging.datacommons.cancer.gov/viewer/1.3.6.1.4.1.14519.5.2.1.177771772342313796313139165433764388011" target=_blank>this website</a>.</span> Click the SAM bookmarklet and select the region to segment.<br><br>Note: This runs well on the <a href="https://portal.imaging.datacommons.cancer.gov/" target=_blank>NCI Imaging Data Commons</a> with the old cornerstone.js!<br><br>

    YOUTUBE: <strong>Watch the bookmarklet in action <a href="https://www.youtube.com/watch?v=2kxrqQfjsQw" target=_blank>here</a>.</strong><br><br>

    <strong>Here is the code for the bookmarklet:</strong> <a href="https://gist.github.com/haehn/bbec8cf8442adea5bb10c08d9c3cc13f" target=_blank>https://gist.github.com/haehn/bbec8cf8442adea5bb10c08d9c3cc13f</a><br><br>

    And <a href="https://cs666.org/onnx/cropper.html" target=_blank>here</a> is an example for a photo with croppr.js in 160 lines of code.<br><br>

    Thanks to Alireza Seghi and Kevin Wang for all the help!<br><br>

    Limitations: We are segmenting the canvas imagedata rather than the original volume (future work :)).

  </body>

</html>